import os
from openai import OpenAI
from dotenv import load_dotenv

load_dotenv()

client = OpenAI()

SYSTEM = """
    당신의 역할은 '상담 대화 일부'를 아래 4개 항목으로만 **문장 단위**로 간결히 요약하는 것입니다.

    [출력 형식(반드시 준수)]
    주요 증상: <2~3문장, 쉼표·슬래시 나열 금지, 완전한 문장으로>
    위험 요인: <2~3문장>
    개선 요인: <2~3문장>
    상담사의 개입 요인: <2~3문장>

    [작성 규칙]
    - 정확히 위 4개 항목만 출력. 머리말/꼬리말/불릿/이모지 금지.
    - **명사구 한 줄 요약 금지**. 반드시 마침표로 끝나는 **완전한 문장**으로 서술.
    - 대화에서 확인된 사실을 근거로 **구체성**을 높이기(누가/언제/무엇을/어떻게).
    - 불확실하면 추정 대신 “정보 부족”을 문장으로 간단히 표기(예: “개선 요인은 대화에서 확인되지 않았다.”).
    - 의학적 진단 단정 금지. 강도·빈도·기간 같은 **관찰 가능한 표현** 사용(예: “자주 깬다”, “1~2 수준으로 낮다” 등).
"""


GEN = dict(
    temperature=0.2,      # 변동성 ↓
    top_p=0.9,
    max_tokens=220,       # 4개 항목 1~2문장씩 충분
    frequency_penalty=0.0,
    presence_penalty=0.0
)

def summarize_dialog(user_text: str):
    resp = client.chat.completions.create(
        model="gpt-4o",
        messages=[
            {"role":"system","content": SYSTEM},
            {"role":"user","content": user_text},
        ],
        **GEN,
    )
    return resp.choices[0].message.content

# user_text_1 = (
#     "다음은 상담 대화 일부입니다. 핵심을 네 항목으로 요약해 주세요.\n\n"
#     "내담자: @TIME에 자궁 적출 수술을 받은 뒤부터 전보다 몸이 확실히 다르고, 땀이 나거나 "
#     "신체 변화가 느껴져요. 피곤하고 기운이 없어요. 잠도 예민해서 자다 깨다를 반복해요.\n"
#     "상담사: 수술 이후 피로감이 두드러지고, 수면도 자주 깨신다고 이해했어요. "
#     "요즘 우울감의 강도를 1~5 중 어느 정도로 느끼시나요?\n"
#     "내담자: 1에서 2 정도요.\n"
# )
# user_text_2 = (
#     "다음은 상담 대화 일부입니다. 핵심을 네 항목으로 요약해 주세요.\n\n"
#     "상담사: 지난 회기 이후 일상에서 불안하게 느낀 사건이 있었나요?\n"
#     "내담자: 특별한 일은 없었는데, 업무 관련해서 잘 해내야 한다는 생각 때문에 걱정이 많아요. "
#     "여러 가지를 과하게 걱정하는 편이고, 잠이 깊지 않아 피곤이 쌓여요.\n"
# )
# user_text_3 = (
#     "다음은 상담 대화 일부입니다. 핵심을 네 항목으로 요약해 주세요.\n\n"
#     "내담자: 최근 들어 출근길에 심장이 두근거리고 손에 땀이 나요. 일찍 잠들어도 새벽에 자꾸 깨요.\n"
#     "상담사: 그런 신체 반응이 언제부터였는지, 그리고 어떤 생각이 떠오르는지 떠올려 보실래요?\n"
#     "내담자: 실수할까 봐 걱정이 커져요. 팀원들에게 민폐가 될까 늘 불안합니다.\n"
# )

# print(summarize_dialog(user_text_1), "\n\n")
# print(summarize_dialog(user_text_2), "\n\n")
# print(summarize_dialog(user_text_3), "\n\n")